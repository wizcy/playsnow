<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­”å¡”åœ°å›¾ç¼–è¾‘å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', SimHei, Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            display: flex;
        }
        
        /* å·¦ä¾§å·¥å…·æ  */
        .toolbar {
            width: 280px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            overflow-y: auto;
            height: 100vh;
            border-right: 2px solid #C76114;
        }
        
        .toolbar h2 {
            color: #C76114;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
            border-bottom: 1px solid #C76114;
            padding-bottom: 10px;
        }
        
        .toolbar h3 {
            color: #ffd700;
            margin: 15px 0 10px;
            font-size: 14px;
        }
        
        .element-category {
            margin-bottom: 15px;
        }
        
        .element-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
        }
        
        .element-item {
            width: 45px;
            height: 45px;
            border: 2px solid transparent;
            cursor: pointer;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }
        
        .element-item:hover {
            border-color: #ffd700;
            transform: scale(1.1);
            z-index: 10;
        }
        
        .element-item.selected {
            border-color: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }
        
        .element-item img {
            max-width: 40px;
            max-height: 40px;
            image-rendering: pixelated;
        }
        
        .element-item .element-id {
            position: absolute;
            bottom: 0;
            right: 0;
            font-size: 8px;
            background: rgba(0,0,0,0.7);
            padding: 1px 3px;
            color: #fff;
        }
        
        /* ä¸»ç¼–è¾‘åŒº */
        .editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .editor-header h1 {
            color: #C76114;
            font-size: 24px;
        }
        
        .editor-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #C76114;
            color: #fff;
        }
        
        .btn-primary:hover {
            background: #e07020;
        }
        
        .btn-success {
            background: #28a745;
            color: #fff;
        }
        
        .btn-success:hover {
            background: #34ce57;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .btn-warning:hover {
            background: #ffcd39;
        }
        
        .btn-danger {
            background: #dc3545;
            color: #fff;
        }
        
        .btn-danger:hover {
            background: #e4606d;
        }
        
        .btn-info {
            background: #17a2b8;
            color: #fff;
        }
        
        .btn-info:hover {
            background: #1fc8e3;
        }
        
        /* åœ°å›¾ç”»å¸ƒå®¹å™¨ */
        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }
        
        #mapCanvas {
            border: 3px solid #C76114;
            cursor: crosshair;
            image-rendering: pixelated;
        }
        
        /* å³ä¾§å±æ€§é¢æ¿ */
        .properties-panel {
            width: 250px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            overflow-y: auto;
            height: 100vh;
            border-left: 2px solid #C76114;
        }
        
        .properties-panel h2 {
            color: #C76114;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
            border-bottom: 1px solid #C76114;
            padding-bottom: 10px;
        }
        
        .property-group {
            margin-bottom: 20px;
        }
        
        .property-group label {
            display: block;
            color: #ffd700;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .property-group input,
        .property-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #C76114;
            border-radius: 5px;
            background: #222;
            color: #fff;
            font-size: 14px;
        }
        
        .property-group input:focus,
        .property-group select:focus {
            outline: none;
            border-color: #ffd700;
        }
        
        .current-element {
            text-align: center;
            padding: 20px;
            background: #333;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .current-element img {
            width: 64px;
            height: 64px;
            image-rendering: pixelated;
            margin-bottom: 10px;
        }
        
        .current-element .element-name {
            color: #ffd700;
            font-size: 16px;
        }
        
        .current-element .element-type {
            color: #888;
            font-size: 12px;
        }
        
        /* åæ ‡æ˜¾ç¤º */
        .coords-display {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .coords-display span {
            color: #00ff00;
            font-family: monospace;
            font-size: 16px;
        }
        
        /* å¿«æ·é”®æç¤º */
        .shortcuts {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .shortcuts h4 {
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .shortcuts p {
            color: #aaa;
            margin: 5px 0;
        }
        
        .shortcuts kbd {
            background: #555;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #C76114;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            color: #C76114;
            margin-bottom: 20px;
        }
        
        .modal-content textarea {
            width: 100%;
            height: 300px;
            background: #222;
            color: #0f0;
            border: 1px solid #C76114;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        /* å†å²è®°å½•æŒ‡ç¤ºå™¨ */
        .history-indicator {
            font-size: 12px;
            color: #888;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§å·¥å…·æ  - å…ƒç´ é€‰æ‹© -->
    <div class="toolbar">
        <h2>ğŸ¨ å…ƒç´ é¢æ¿</h2>
        
        <!-- åœ°å½¢ç±» -->
        <div class="element-category">
            <h3>ğŸ”ï¸ åœ°å½¢</h3>
            <div class="element-grid" id="terrainElements"></div>
        </div>
        
        <!-- é—¨ç±» -->
        <div class="element-category">
            <h3>ğŸšª é—¨</h3>
            <div class="element-grid" id="doorElements"></div>
        </div>
        
        <!-- æ¥¼æ¢¯ç±» -->
        <div class="element-category">
            <h3>ğŸªœ æ¥¼æ¢¯</h3>
            <div class="element-grid" id="stairElements"></div>
        </div>
        
        <!-- é“å…·ç±» -->
        <div class="element-category">
            <h3>ğŸ”‘ é“å…·</h3>
            <div class="element-grid" id="itemElements"></div>
        </div>
        
        <!-- è£…å¤‡ç±» -->
        <div class="element-category">
            <h3>âš”ï¸ è£…å¤‡</h3>
            <div class="element-grid" id="equipElements"></div>
        </div>
        
        <!-- NPCç±» -->
        <div class="element-category">
            <h3>ğŸ‘¤ NPC</h3>
            <div class="element-grid" id="npcElements"></div>
        </div>
        
        <!-- æ€ªç‰©ç±» -->
        <div class="element-category">
            <h3>ğŸ‘¹ æ€ªç‰©</h3>
            <div class="element-grid" id="monsterElements"></div>
        </div>
        
        <!-- ç‰¹æ®Šç±» -->
        <div class="element-category">
            <h3>âœ¨ ç‰¹æ®Š</h3>
            <div class="element-grid" id="specialElements"></div>
        </div>
    </div>
    
    <!-- ä¸»ç¼–è¾‘åŒº -->
    <div class="editor-main">
        <div class="editor-header">
            <h1>ğŸ—ºï¸ é­”å¡”åœ°å›¾ç¼–è¾‘å™¨</h1>
            <div class="editor-controls">
                <button class="btn btn-primary" onclick="newMap()">ğŸ“„ æ–°å»º</button>
                <button class="btn btn-info" onclick="loadMapFile()">ğŸ“‚ åŠ è½½</button>
                <button class="btn btn-success" onclick="exportMap()">ğŸ’¾ å¯¼å‡º</button>
                <button class="btn btn-warning" onclick="undo()">â†©ï¸ æ’¤é”€</button>
                <button class="btn btn-warning" onclick="redo()">â†ªï¸ é‡åš</button>
                <button class="btn btn-danger" onclick="clearMap()">ğŸ—‘ï¸ æ¸…ç©º</button>
                <button class="btn btn-info" onclick="testMap()">â–¶ï¸ æµ‹è¯•</button>
                <span class="history-indicator" id="historyIndicator"></span>
            </div>
        </div>
        
        <div class="canvas-container">
            <canvas id="mapCanvas"></canvas>
        </div>
    </div>
    
    <!-- å³ä¾§å±æ€§é¢æ¿ -->
    <div class="properties-panel">
        <h2>âš™ï¸ å±æ€§</h2>
        
        <!-- å½“å‰é€‰ä¸­å…ƒç´  -->
        <div class="current-element" id="currentElement">
            <img src="" alt="" id="currentElementImg" style="display:none;">
            <div class="element-name" id="currentElementName">æœªé€‰æ‹©</div>
            <div class="element-type" id="currentElementType">ç‚¹å‡»å·¦ä¾§å…ƒç´ é€‰æ‹©</div>
        </div>
        
        <!-- åæ ‡æ˜¾ç¤º -->
        <div class="coords-display">
            é¼ æ ‡ä½ç½®: <span id="coordsDisplay">--, --</span>
        </div>
        
        <!-- åœ°å›¾è®¾ç½® -->
        <div class="property-group">
            <label>åœ°å›¾å®½åº¦ (æ ¼)</label>
            <input type="number" id="mapWidth" value="11" min="5" max="30" onchange="resizeMap()">
        </div>
        
        <div class="property-group">
            <label>åœ°å›¾é«˜åº¦ (æ ¼)</label>
            <input type="number" id="mapHeight" value="11" min="5" max="30" onchange="resizeMap()">
        </div>
        
        <div class="property-group">
            <label>å¡«å……å…ƒç´ </label>
            <select id="fillElement">
                <option value="0">åœ°é¢ (0)</option>
                <option value="1">å¢™å£ (1)</option>
                <option value="19">çŸ³å¢™ (19)</option>
                <option value="20">è“å¢™ (20)</option>
            </select>
        </div>
        
        <div class="property-group">
            <label>ç»˜åˆ¶æ¨¡å¼</label>
            <select id="drawMode">
                <option value="single">å•ç‚¹ç»˜åˆ¶</option>
                <option value="line">çº¿æ®µç»˜åˆ¶</option>
                <option value="rect">çŸ©å½¢ç»˜åˆ¶</option>
                <option value="fill">å¡«å……ç»˜åˆ¶</option>
            </select>
        </div>
        
        <!-- å¿«æ·é”® -->
        <div class="shortcuts">
            <h4>âŒ¨ï¸ å¿«æ·é”®</h4>
            <p><kbd>Ctrl+Z</kbd> æ’¤é”€</p>
            <p><kbd>Ctrl+Y</kbd> é‡åš</p>
            <p><kbd>Ctrl+S</kbd> å¯¼å‡º</p>
            <p><kbd>Del</kbd> åˆ é™¤(å¡«0)</p>
            <p><kbd>1-4</kbd> åˆ‡æ¢æ¨¡å¼</p>
            <p><kbd>é¼ æ ‡å³é”®</kbd> å–è‰²</p>
        </div>
    </div>
    
    <!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h3>ğŸ“¤ å¯¼å‡ºåœ°å›¾æ•°æ®</h3>
            <textarea id="exportData" readonly></textarea>
            <div class="modal-buttons">
                <button class="btn btn-success" onclick="copyExportData()">ğŸ“‹ å¤åˆ¶</button>
                <button class="btn btn-primary" onclick="downloadMap()">â¬‡ï¸ ä¸‹è½½</button>
                <button class="btn btn-danger" onclick="closeModal('exportModal')">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½æ¨¡æ€æ¡† -->
    <div class="modal" id="loadModal">
        <div class="modal-content">
            <h3>ğŸ“¥ åŠ è½½åœ°å›¾æ•°æ®</h3>
            <textarea id="loadData" placeholder="ç²˜è´´åœ°å›¾æ•°æ®æˆ–é€‰æ‹©æ–‡ä»¶..."></textarea>
            <div class="modal-buttons">
                <input type="file" id="fileInput" accept=".lvl,.txt" style="display:none" onchange="handleFileSelect(event)">
                <button class="btn btn-info" onclick="document.getElementById('fileInput').click()">ğŸ“‚ é€‰æ‹©æ–‡ä»¶</button>
                <button class="btn btn-success" onclick="loadFromTextarea()">âœ“ åŠ è½½</button>
                <button class="btn btn-danger" onclick="closeModal('loadModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®
        const BLOCK_SIZE = 45;
        const IMAGE_PATH = 'resources/images/map0/';
        
        // å…ƒç´ åˆ†ç±»
        const ELEMENT_CATEGORIES = {
            terrain: ['0', '1', '19', '20'],
            door: ['2', '3', '4', '15'],
            stair: ['12', '13', '14'],
            item: ['5', '6', '7', '8', '9', '10', '11', '21', '22', '23', '30', '31', '32', '33', '34', '35', '36', '38', '39'],
            equip: ['71', '73', '75', '76', '78', '80'],
            npc: ['24', '25', '26', '27', '28'],
            monster: ['40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70'],
            special: ['hero', '181', '182', '183', '184', '185', '186', '187', '188', '189', '191', '192', '193', '194', '195', '196', '197', '198', '199', '202', '203', '340']
        };
        
        // å…ƒç´ åç§°æ˜ å°„
        const ELEMENT_NAMES = {
            '0': 'åœ°é¢', '1': 'å¢™å£', '19': 'çŸ³å¢™', '20': 'è“å¢™',
            '2': 'é»„é—¨', '3': 'è“é—¨', '4': 'çº¢é—¨', '15': 'é“é—¨',
            '12': 'ä¸‹æ¥¼æ¢¯', '13': 'ä¸Šæ¥¼æ¢¯', '14': 'ä¼ é€é—¨',
            '5': 'é»„é’¥åŒ™', '6': 'è“é’¥åŒ™', '7': 'çº¢é’¥åŒ™',
            '8': 'çº¢è¯æ°´', '9': 'è“å®çŸ³', '10': 'çº¢å®çŸ³', '11': 'è“è¯æ°´',
            '21': 'å‰‘', '22': 'ç›¾', '23': 'åœ£å…‰å¾½', '24': 'ä»™å¥³', '25': 'ç›—è´¼', '26': 'è€äºº', '27': 'å•†äºº', '28': 'å…¬ä¸»',
            '30': 'ç¥åœ£ç›¾', '31': 'åœ£å‰‘', '32': 'ç¥åœ£å‰‘', '33': 'é£ä¹‹ç½—ç›˜', '34': 'åå­—æ¶', '35': 'é”¤å­', '36': 'å†°ä¹‹æ³•æ–',
            '38': 'ç«ä¹‹æ³•æ–', '39': 'å¿ƒä¹‹æ³•æ–',
            '40': 'ç»¿å¤´æ€ª', '41': 'çº¢å¤´æ€ª', '42': 'å°è™è ', '43': 'é’å¤´æ€ª', '44': 'éª·é«…äºº', '45': 'éª·é«…å£«å…µ',
            '46': 'å…½é¢äºº', '47': 'åˆçº§å«å…µ', '48': 'å¤§è™è ', '49': 'çº¢è™è ', '50': 'ç™½è¡£æ­¦å£«', '51': 'æ€ªç‹',
            '52': 'çº¢è¡£æ³•å¸ˆ', '53': 'çº¢è¡£é­”ç‹', '54': 'é‡‘ç”²å«å£«', '55': 'é‡‘ç”²é˜Ÿé•¿', '56': 'éª·é«…é˜Ÿé•¿',
            '57': 'çµæ³•å¸ˆ', '58': 'çµæ­¦å£«', '59': 'å†¥çµé­”ç‹', '60': 'éº»è¡£æ³•å¸ˆ', '61': 'å†¥æˆ˜å£«', '62': 'å†¥é˜Ÿé•¿',
            '63': 'åˆçº§æ³•å¸ˆ', '64': 'é«˜çº§æ³•å¸ˆ', '65': 'çŸ³å¤´æ€ªäºº', '66': 'å…½é¢æˆ˜å£«', '67': 'åŒæ‰‹å‰‘å£«',
            '68': 'å†¥å«å…µ', '69': 'é«˜çº§å«å…µ', '70': 'å½±å­æˆ˜å£«',
            '71': 'é“å‰‘', '73': 'é’¢å‰‘', '75': 'ç¥åœ£å‰‘', '76': 'é“ç›¾', '78': 'é’¢ç›¾', '80': 'ç¥åœ£ç›¾',
            '188': 'è¡€å½±', '198': 'é­”é¾™',
            'hero': 'è‹±é›„'
        };
        
        // çŠ¶æ€
        let mapData = [];
        let mapWidth = 11;
        let mapHeight = 11;
        let selectedElement = '0';
        let images = {};
        let canvas, ctx;
        let history = [];
        let historyIndex = -1;
        let isDrawing = false;
        let lastDrawPos = null;
        
        // åˆå§‹åŒ–
        window.onload = async function() {
            canvas = document.getElementById('mapCanvas');
            ctx = canvas.getContext('2d');
            
            // åŠ è½½å›¾ç‰‡
            await loadImages();
            
            // åˆå§‹åŒ–å…ƒç´ é¢æ¿
            initElementPanels();
            
            // åˆå§‹åŒ–åœ°å›¾
            initMap();
            
            // ç»‘å®šäº‹ä»¶
            bindEvents();
            
            // æ›´æ–°å†å²æŒ‡ç¤ºå™¨
            updateHistoryIndicator();
        };
        
        // åŠ è½½æ‰€æœ‰å…ƒç´ å›¾ç‰‡
        async function loadImages() {
            const allElements = Object.values(ELEMENT_CATEGORIES).flat();
            
            for (const elem of allElements) {
                if (elem === 'hero') {
                    // è‹±é›„ä½¿ç”¨ç‰¹æ®Šè·¯å¾„
                    images[elem] = await loadImage('resources/images/player/down.png');
                } else {
                    images[elem] = await loadImage(IMAGE_PATH + elem + '.png');
                }
            }
        }
        
        function loadImage(src) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = src;
            });
        }
        
        // åˆå§‹åŒ–å…ƒç´ é¢æ¿
        function initElementPanels() {
            const panels = {
                'terrainElements': ELEMENT_CATEGORIES.terrain,
                'doorElements': ELEMENT_CATEGORIES.door,
                'stairElements': ELEMENT_CATEGORIES.stair,
                'itemElements': ELEMENT_CATEGORIES.item,
                'equipElements': ELEMENT_CATEGORIES.equip,
                'npcElements': ELEMENT_CATEGORIES.npc,
                'monsterElements': ELEMENT_CATEGORIES.monster,
                'specialElements': ELEMENT_CATEGORIES.special
            };
            
            for (const [panelId, elements] of Object.entries(panels)) {
                const panel = document.getElementById(panelId);
                if (!panel) continue;
                
                for (const elem of elements) {
                    const div = document.createElement('div');
                    div.className = 'element-item';
                    div.dataset.element = elem;
                    div.title = ELEMENT_NAMES[elem] || elem;
                    
                    if (images[elem]) {
                        const img = document.createElement('img');
                        img.src = images[elem].src;
                        div.appendChild(img);
                    }
                    
                    const idSpan = document.createElement('span');
                    idSpan.className = 'element-id';
                    idSpan.textContent = elem;
                    div.appendChild(idSpan);
                    
                    div.onclick = () => selectElement(elem);
                    
                    panel.appendChild(div);
                }
            }
            
            // é»˜è®¤é€‰ä¸­åœ°é¢
            selectElement('0');
        }
        
        // é€‰æ‹©å…ƒç´ 
        function selectElement(elem) {
            selectedElement = elem;
            
            // æ›´æ–°UI
            document.querySelectorAll('.element-item').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.element === elem) {
                    item.classList.add('selected');
                }
            });
            
            // æ›´æ–°å½“å‰å…ƒç´ æ˜¾ç¤º
            const img = document.getElementById('currentElementImg');
            const name = document.getElementById('currentElementName');
            const type = document.getElementById('currentElementType');
            
            if (images[elem]) {
                img.src = images[elem].src;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }
            
            name.textContent = ELEMENT_NAMES[elem] || elem;
            type.textContent = `ID: ${elem}`;
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            mapWidth = parseInt(document.getElementById('mapWidth').value);
            mapHeight = parseInt(document.getElementById('mapHeight').value);
            const fillElem = document.getElementById('fillElement').value;
            
            mapData = [];
            for (let y = 0; y < mapHeight; y++) {
                const row = [];
                for (let x = 0; x < mapWidth; x++) {
                    row.push(fillElem);
                }
                mapData.push(row);
            }
            
            resizeCanvas();
            renderMap();
            saveHistory();
        }
        
        // è°ƒæ•´ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            canvas.width = mapWidth * BLOCK_SIZE;
            canvas.height = mapHeight * BLOCK_SIZE;
        }
        
        // è°ƒæ•´åœ°å›¾å¤§å°
        function resizeMap() {
            const newWidth = parseInt(document.getElementById('mapWidth').value);
            const newHeight = parseInt(document.getElementById('mapHeight').value);
            const fillElem = document.getElementById('fillElement').value;
            
            const newData = [];
            for (let y = 0; y < newHeight; y++) {
                const row = [];
                for (let x = 0; x < newWidth; x++) {
                    if (y < mapHeight && x < mapWidth) {
                        row.push(mapData[y][x]);
                    } else {
                        row.push(fillElem);
                    }
                }
                newData.push(row);
            }
            
            mapData = newData;
            mapWidth = newWidth;
            mapHeight = newHeight;
            
            resizeCanvas();
            renderMap();
            saveHistory();
        }
        
        // æ¸²æŸ“åœ°å›¾
        function renderMap() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            for (let y = 0; y < mapHeight; y++) {
                for (let x = 0; x < mapWidth; x++) {
                    const elem = mapData[y][x];
                    const px = x * BLOCK_SIZE;
                    const py = y * BLOCK_SIZE;
                    
                    // ç»˜åˆ¶èƒŒæ™¯æ ¼å­
                    ctx.fillStyle = '#222';
                    ctx.fillRect(px, py, BLOCK_SIZE, BLOCK_SIZE);
                    ctx.strokeStyle = '#444';
                    ctx.strokeRect(px, py, BLOCK_SIZE, BLOCK_SIZE);
                    
                    // ç»˜åˆ¶å…ƒç´ 
                    if (images[elem]) {
                        ctx.drawImage(images[elem], px + 2, py + 2, BLOCK_SIZE - 4, BLOCK_SIZE - 4);
                    } else if (elem !== '0' && elem !== '00') {
                        // æœªçŸ¥å…ƒç´ æ˜¾ç¤ºID
                        ctx.fillStyle = '#f00';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(elem, px + BLOCK_SIZE/2, py + BLOCK_SIZE/2 + 4);
                    }
                }
            }
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç”»å¸ƒé¼ æ ‡äº‹ä»¶
            canvas.addEventListener('mousedown', onCanvasMouseDown);
            canvas.addEventListener('mousemove', onCanvasMouseMove);
            canvas.addEventListener('mouseup', onCanvasMouseUp);
            canvas.addEventListener('mouseleave', onCanvasMouseUp);
            canvas.addEventListener('contextmenu', onCanvasRightClick);
            
            // é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', onKeyDown);
        }
        
        function getGridPos(e) {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / BLOCK_SIZE);
            const y = Math.floor((e.clientY - rect.top) / BLOCK_SIZE);
            return { x: Math.max(0, Math.min(x, mapWidth - 1)), y: Math.max(0, Math.min(y, mapHeight - 1)) };
        }
        
        function onCanvasMouseDown(e) {
            if (e.button === 0) { // å·¦é”®
                isDrawing = true;
                const pos = getGridPos(e);
                drawAt(pos.x, pos.y);
                lastDrawPos = pos;
            }
        }
        
        function onCanvasMouseMove(e) {
            const pos = getGridPos(e);
            document.getElementById('coordsDisplay').textContent = `${pos.x}, ${pos.y}`;
            
            if (isDrawing) {
                const mode = document.getElementById('drawMode').value;
                if (mode === 'single' || mode === 'line') {
                    if (!lastDrawPos || pos.x !== lastDrawPos.x || pos.y !== lastDrawPos.y) {
                        drawAt(pos.x, pos.y);
                        lastDrawPos = pos;
                    }
                }
            }
        }
        
        function onCanvasMouseUp(e) {
            if (isDrawing) {
                isDrawing = false;
                lastDrawPos = null;
                saveHistory();
            }
        }
        
        function onCanvasRightClick(e) {
            e.preventDefault();
            const pos = getGridPos(e);
            const elem = mapData[pos.y][pos.x];
            selectElement(elem);
        }
        
        function drawAt(x, y) {
            if (x >= 0 && x < mapWidth && y >= 0 && y < mapHeight) {
                mapData[y][x] = selectedElement;
                renderMap();
            }
        }
        
        function onKeyDown(e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'z') {
                    e.preventDefault();
                    undo();
                } else if (e.key === 'y') {
                    e.preventDefault();
                    redo();
                } else if (e.key === 's') {
                    e.preventDefault();
                    exportMap();
                }
            } else if (e.key === 'Delete' || e.key === 'Backspace') {
                selectElement('0');
            } else if (e.key >= '1' && e.key <= '4') {
                const modes = ['single', 'line', 'rect', 'fill'];
                document.getElementById('drawMode').value = modes[parseInt(e.key) - 1];
            }
        }
        
        // å†å²è®°å½•
        function saveHistory() {
            // åˆ é™¤å½“å‰ä½ç½®ä¹‹åçš„å†å²
            history = history.slice(0, historyIndex + 1);
            
            // ä¿å­˜å½“å‰çŠ¶æ€
            history.push(JSON.stringify(mapData));
            historyIndex = history.length - 1;
            
            // é™åˆ¶å†å²é•¿åº¦
            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }
            
            updateHistoryIndicator();
        }
        
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                mapData = JSON.parse(history[historyIndex]);
                mapWidth = mapData[0].length;
                mapHeight = mapData.length;
                document.getElementById('mapWidth').value = mapWidth;
                document.getElementById('mapHeight').value = mapHeight;
                resizeCanvas();
                renderMap();
                updateHistoryIndicator();
            }
        }
        
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                mapData = JSON.parse(history[historyIndex]);
                mapWidth = mapData[0].length;
                mapHeight = mapData.length;
                document.getElementById('mapWidth').value = mapWidth;
                document.getElementById('mapHeight').value = mapHeight;
                resizeCanvas();
                renderMap();
                updateHistoryIndicator();
            }
        }
        
        function updateHistoryIndicator() {
            const indicator = document.getElementById('historyIndicator');
            indicator.textContent = `å†å²: ${historyIndex + 1}/${history.length}`;
        }
        
        // æ–°å»ºåœ°å›¾
        function newMap() {
            if (confirm('ç¡®å®šè¦æ–°å»ºåœ°å›¾å—ï¼Ÿå½“å‰åœ°å›¾å°†ä¸¢å¤±ã€‚')) {
                history = [];
                historyIndex = -1;
                initMap();
            }
        }
        
        // æ¸…ç©ºåœ°å›¾
        function clearMap() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºåœ°å›¾å—ï¼Ÿ')) {
                const fillElem = document.getElementById('fillElement').value;
                for (let y = 0; y < mapHeight; y++) {
                    for (let x = 0; x < mapWidth; x++) {
                        mapData[y][x] = fillElem;
                    }
                }
                renderMap();
                saveHistory();
            }
        }
        
        // å¯¼å‡ºåœ°å›¾
        function exportMap() {
            let output = '';
            for (let y = 0; y < mapHeight; y++) {
                output += mapData[y].join(', ') + '\n';
            }
            
            document.getElementById('exportData').value = output;
            document.getElementById('exportModal').classList.add('active');
        }
        
        function copyExportData() {
            const textarea = document.getElementById('exportData');
            textarea.select();
            document.execCommand('copy');
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }
        
        function downloadMap() {
            const data = document.getElementById('exportData').value;
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'custom_map.lvl';
            a.click();
            
            URL.revokeObjectURL(url);
        }
        
        // åŠ è½½åœ°å›¾
        function loadMapFile() {
            document.getElementById('loadData').value = '';
            document.getElementById('loadModal').classList.add('active');
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('loadData').value = e.target.result;
                };
                reader.readAsText(file);
            }
        }
        
        function loadFromTextarea() {
            const data = document.getElementById('loadData').value.trim();
            if (!data) {
                alert('è¯·è¾“å…¥åœ°å›¾æ•°æ®ï¼');
                return;
            }
            
            try {
                const lines = data.split('\n').filter(l => l.trim());
                const newData = [];
                
                for (const line of lines) {
                    const row = line.split(',').map(c => c.trim());
                    newData.push(row);
                }
                
                if (newData.length > 0 && newData[0].length > 0) {
                    mapData = newData;
                    mapHeight = newData.length;
                    mapWidth = newData[0].length;
                    
                    document.getElementById('mapWidth').value = mapWidth;
                    document.getElementById('mapHeight').value = mapHeight;
                    
                    resizeCanvas();
                    renderMap();
                    saveHistory();
                    
                    closeModal('loadModal');
                    alert('åœ°å›¾åŠ è½½æˆåŠŸï¼');
                } else {
                    alert('åœ°å›¾æ•°æ®æ ¼å¼é”™è¯¯ï¼');
                }
            } catch (e) {
                alert('è§£æåœ°å›¾æ•°æ®å¤±è´¥ï¼š' + e.message);
            }
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        // æµ‹è¯•åœ°å›¾
        function testMap() {
            // å°†åœ°å›¾ä¿å­˜åˆ°localStorageï¼Œç„¶åè·³è½¬åˆ°æ¸¸æˆé¡µé¢
            localStorage.setItem('editor_test_map', JSON.stringify(mapData));
            alert('æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...\nåœ°å›¾å·²ä¿å­˜ï¼Œè¯·æ‰‹åŠ¨å°†å¯¼å‡ºçš„.lvlæ–‡ä»¶æ›¿æ¢åˆ°resources/levels/ç›®å½•ä¸‹è¿›è¡Œæµ‹è¯•ã€‚');
        }
    </script>
</body>
</html>
